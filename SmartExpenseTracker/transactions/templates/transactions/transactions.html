{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transactions | SmartTracker</title>
    <link
      rel="stylesheet"
      href="{% static 'transactions/css/transactions.css' %}"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
  </head>

  <body>
    <div class="dashboard-wrapper">
      <!-- Sidebar -->
      <aside class="sidebar">
        <a href="{% url 'core:landing' %}" class="brand-link"
          ><h2 class="brand">Smart<span>Tracker</span></h2></a
        >

        <nav class="menu">
          <a href="{% url 'dashboard:dashboard_view' %}">Dashboard</a>
          <a href="{% url 'transactions:add_transaction' %}">Add Transaction</a>
          <a href="{% url 'transactions:transactions' %}" class="active"
            >Transactions</a
          >
          <a href="{% url 'transactions:categories' %}">Categories</a>
          <a href="{% url 'transactions:reports' %}">Reports</a>
          <a href="{% url 'accounts:logout_view' %}" class="logout">Logout</a>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Topbar -->
        <header class="topbar">
          <div class="header-left">
            <h1>Transactions</h1>
          </div>
          <div class="top-actions">
            <a
              href="{% url 'transactions:add_transaction' %}"
              class="btn primary"
              >+ Add Transaction</a
            >
            <a href="{% url 'dashboard:dashboard_view' %}" class="btn secondary"
              >← Back</a
            >
          </div>
        </header>

        <!-- Django Messages -->
        {% if messages %}
        <div class="messages">
          {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Filters -->
        <section class="filters">
          <form method="get" class="filter-form">
            <div class="filter-group-row">
              <div class="filter-group search-group">
                <label>Search</label>
                <input
                  type="text"
                  name="q"
                  value="{{ search_query }}"
                  placeholder="Search description, category..."
                />
              </div>

              <div class="filter-group">
                <label>From</label>
                <input
                  type="text"
                  id="filterFrom"
                  name="from"
                  value="{{ filter_from }}"
                  placeholder="Select date"
                  readonly
                />
              </div>

              <div class="filter-group">
                <label>To</label>
                <input
                  type="text"
                  id="filterTo"
                  name="to"
                  value="{{ filter_to }}"
                  placeholder="Select date"
                  readonly
                />
              </div>

              <div class="filter-group">
                <label>Category</label>
                <select name="category">
                  <option value="">All Categories</option>
                  {% for cat in all_categories %}
                  <option
                    value="{{ cat }}"
                    {%
                    if
                    filter_category=""
                    ="cat"
                    %}selected{%
                    endif
                    %}
                  >
                    {{ cat }}
                  </option>
                  {% endfor %}
                </select>
              </div>

              <div class="filter-group">
                <label>Type</label>
                <select name="type">
                  <option value="">All Types</option>
                  <option
                    value="income"
                    {%
                    if
                    filter_type=""
                    ="income"
                    %}selected{%
                    endif
                    %}
                  >
                    Income
                  </option>
                  <option
                    value="expense"
                    {%
                    if
                    filter_type=""
                    ="expense"
                    %}selected{%
                    endif
                    %}
                  >
                    Expense
                  </option>
                </select>
              </div>

              <div class="filter-group actions">
                <button type="submit" class="btn primary">Apply</button>
                <a
                  href="{% url 'transactions:transactions' %}"
                  class="btn secondary"
                  >Clear</a
                >
              </div>
            </div>
          </form>
        </section>

        <!-- Transactions Table -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Description</th>
                <th>Category</th>
                <th>Amount</th>
                <th>Type</th>
                <th>Payment</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              {% for txn in transactions %}
              <tr>
                <td>{{ txn.date|date:"d M Y" }}</td>
                <td>{{ txn.description|default:"—" }}</td>
                <td>{{ txn.category }}</td>
                <td>₹{{ txn.amount|floatformat:2 }}</td>
                <td
                  class="{% if txn.transaction_type|lower == 'income' %}income-text{% else %}expense-text{% endif %}"
                >
                  {{ txn.transaction_type }}
                </td>
                <td>{{ txn.payment_mode }}</td>
                <td>
                  <a
                    href="{% url 'transactions:edit_transaction' txn.pk %}"
                    class="action-btn edit"
                    >Edit</a
                  >
                  <a
                    href="{% url 'transactions:delete_transaction' txn.pk %}"
                    class="action-btn delete"
                    onclick="
                      return confirm(
                        'Are you sure you want to delete this transaction?',
                      );
                    "
                    >Delete</a
                  >
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" style="text-align: center; color: #636e72">
                  No transactions found.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
      // Flatpickr initialization
      var fpConfig = {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d M Y",
        disableMobile: true,
      };
      flatpickr("#filterFrom", fpConfig);
      flatpickr("#filterTo", fpConfig);

      // Alert timeout
      setTimeout(() => {
        document.querySelectorAll(".alert").forEach((alert) => {
          alert.style.transition = "opacity 0.5s ease";
          alert.style.opacity = "0";
          setTimeout(() => alert.remove(), 500);
        });
      }, 3000);
    </script>
  </body>
</html>
